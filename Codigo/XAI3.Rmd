---
title: "XAI3"
date: "`r Sys.Date()`"
output: html_document
---

# 1. One dimensional Partial Dependence Plot
```{r}
#install.packages("randomForest")
#install.packages("pdp")
library(randomForest)
library(pdp)
library(ggplot2)

data = read.csv('Datos/hour.csv')

data$season_winter <- ifelse(data$season == 1, 1, 0)
data$season_spring <- ifelse(data$season == 2, 1, 0)
data$season_summer <- ifelse(data$season == 3, 1, 0)

data$MISTY <- ifelse(data$weathersit == 2, 1, 0)

data$RAIN <- ifelse(data$weathersit %in% c(3,4), 1, 0)

data$temp <- (data$temp) * (39-(-8)) + (-8)

data$hum <- data$hum * 100

data$windspeed <- data$windspeed * 67

data$dteday <- as.Date(data$dteday)
start_date <- as.Date("2011-01-01")
data$days_since_2011 <- as.numeric(data$dteday - start_date)


model_data <- data[, c("workingday", "holiday", "season_winter", "season_spring", 
                           "season_summer", "MISTY", "RAIN", "temp", "hum", 
                           "windspeed", "days_since_2011", "cnt")]


```

```{r}
# Fit Random Forest model
rf_model <- randomForest(cnt ~ days_since_2011 + temp + hum + windspeed, data = model_data, ntree = 500)
```


```{r}
# PDP for days since 2011
pdp_days <- partial(rf_model, pred.var = "days_since_2011", grid.resolution = 100)
```

```{r}
ggplot(pdp_days, aes(x = days_since_2011, y = yhat)) +
  geom_path() +
  geom_line(color = "#9FBFB6") +
  geom_rug(alpha=0.9, color = '#D9A282', sides = "b") +  # "l" indica solo el lado izquierdo (eje Y)
  labs(title = "PDP for days_since_2011",
       x = "days_since_2011",
       y = "Partial Dependence") +
  theme_minimal()
```

```{r}
# Repeat for other variables
pdp_temp <- partial(rf_model, pred.var = "temp", grid.resolution = 100)
```

```{r}
ggplot(pdp_temp, aes(x = temp, y = yhat)) +
  geom_path() +
  geom_line(color = "#9FBFB6") +
  geom_rug(alpha=0.9, color = '#D9A282', sides = "b") +
  labs(title = "PDP for Temperature",
       x = "Temperature",
       y = "Partial Dependence") +
  theme_minimal()
```


```{r}
pdp_humidity <- partial(rf_model, pred.var = "hum", grid.resolution = 100)
```
```{r}
ggplot(pdp_humidity, aes(x = hum, y = yhat)) +
  geom_path() +
  geom_line(color = "#9FBFB6") +
  geom_rug(alpha=0.9, color = '#D9A282', sides = "b") +
  labs(title = "PDP for Humidity",
       x = "Humidity",
       y = "Partial Dependence") +
  theme_minimal()
```


```{r}
pdp_windspeed <- partial(rf_model, pred.var = "windspeed", grid.resolution = 100)
```
```{r}
ggplot(pdp_windspeed, aes(x = windspeed, y = yhat)) +
  geom_path() +
  geom_line(color = "#9FBFB6") +
  geom_rug(alpha=0.9, color = '#D9A282', sides = "b") +
  labs(title = "PDP for Windspeed",
       x = "Windspeed",
       y = "Partial Dependence") +
  theme_minimal()
```

# 2. Bidimensional Partial Dependency Plot.
```{r}
library(ggplot2)
library(randomForest)
library(dplyr)

set.seed(123) 
sampled_data <- sample_n(model_data, size = 2000) 
```

```{r}
model <- randomForest(cnt ~ temp + hum, data = sampled_data)
```

```{r}
# Create a grid of values for temperature and humidity
temp_seq <- seq(from = min(sampled_data$temp), to = max(sampled_data$temp), length.out = 50)
hum_seq <- seq(from = min(sampled_data$hum), to = max(sampled_data$hum), length.out = 50)
grid <- expand.grid(temp = temp_seq, hum = hum_seq)

```


```{r}
grid$predicted_cnt = predict(model, newdata = grid)
```

```{r}
p = ggplot() +
  geom_tile(data = grid, aes(x = temp, y = hum, fill = predicted_cnt)) +  # Create the 2D plot
  geom_density_2d(data = data, aes(x = temp, y = hum), linewidth = 0.3, color = "white") +  # Overlay density lines
  scale_fill_gradientn(colors = c("#416C7B", "#9FBFB6", "#F2D4AE", "#D9A282")) +  # Custom color gradient
  labs(title = "2D Partial Dependency Plot with Density Overlay",
       subtitle = "Effect of Temperature and Humidity on Bike Rentals",
       x = "Temperature (Â°C)", y = "Humidity (%)",
       fill = "Predicted Number of Bikes Rented") +
  theme_minimal()
p

```

# 3. PDP to explain the price of a house.

```{r}
# Load necessary libraries
library(randomForest)
library(ggplot2)
library(dplyr)

kc_house_data <- read.csv("Datos/kc_house_data.csv")
str(kc_house_data)
```

```{r}
# Set seed for reproducibility
set.seed(123)

# Sample the data
sampled_data <- kc_house_data %>% sample_n(1000)  # Adjust the sample size as needed
```

```{r}
# Train the Random Forest model
model <- randomForest(price ~ bedrooms + bathrooms + sqft_living + sqft_lot + floors + yr_built,
                      data = sampled_data)
```

```{r}
# Function to generate partial dependency data for a single feature
generate_pdp_data <- function(model, data, feature, grid_points = 50) {
  grid <- data.frame(feature = seq(min(data[[feature]]), max(data[[feature]]), length.out = grid_points))
  colnames(grid) <- feature
  other_features <- setdiff(names(data), c(feature, "price"))
  for (f in other_features) {
    grid[[f]] <- mean(data[[f]], na.rm = TRUE)
  }
  grid$predicted_price <- predict(model, newdata = grid)
  return(grid)
}

# Generate PDP data for each feature
features <- c("bedrooms", "bathrooms", "sqft_living", "sqft_lot", "floors", "yr_built")
pdp_data <- lapply(features, function(f) {
  pdp <- generate_pdp_data(model, sampled_data, f)
  colnames(pdp)[1] <- f
  return(pdp)
})

# Function to plot the partial dependency for a single feature with color
plot_pdp <- function(pdp_data, feature, color = "#9FBFB6") {
  ggplot(pdp_data, aes_string(x = feature, y = "predicted_price")) +
    geom_path() +
    geom_line(color = color) +
    geom_rug(alpha = 0.9, color = '#D9A282', sides = "b") +
    labs(title = paste("Partial Dependency Plot:", feature),
         x = feature, y = "Predicted Price") +
    theme_minimal()
}

# Create and display PDP plots with color
pdp_plots <- lapply(1:length(features), function(i) plot_pdp(pdp_data[[i]], features[i], color = "#9FBFB6"))

# Print PDP plots
library(gridExtra)
do.call(grid.arrange, c(pdp_plots, ncol = 2))
```



